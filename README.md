# Preventing traffic analysis attacks on Android
Project for the Seminar in Distributed Systems at La Sapienza University of Rome

## Introduction

### Traffic analysis attacks: Website Fingerprinting

<p align="justify"><i>Website Fingerprinting</i> is a process aimed at discovering the web pages visited by a client leveraging the analysis of the related network traffic traces: when this process is carried on by an attacker with malicious intentions, it represents a serious threat for the privacy of the client. The attacker doesn't have much attack power, since he passively observes the network traffic that involves the victim client: he is capable of doing this either when he is located in the same network as the client or when he previously has taken control over the router used by the client as gateway to access the Internet. The attack consists of two phases:</p>
<ol>
  <li>the attacker collects a number of traffic traces from a set of web pages he wants to monitor; meanwhile he trains a classifier executing a <i>supervised training</i>, labeling the traces with the URL of the pages they were originated from</li>
  <li>the attacker sniffs the network traffic caused by his victim and, thanks to the trained classifier, he is able to detect whether the client is visiting one of the monitored web pages</li>
</ol>
<p>The classification is based on the computation of the <i>distance</i> between the sequences of packets: the lower is the distance, the more similar are the two sequences and the more likely is that they come from the same web page. There are various possible definitions for this distance, but they are all ultimately based on the evaluation of some <i>features</i> characterising the network traces, like the number of unique packets lengths.</p>

### Tor and Orbot

<p align="justify"><i>Anonymity systems</i> are overlay networks aimed at anonymizing TCP-based applications, namely avoiding that an attacker can determine the application's communication partner. Tor is an example of <i>low-latency, distributed-trust, circuit-based</i> anonymity system. Like any other low-latency anononymity system, Tor is designed to anonymize interactive applications. Within the Tor network, client applications create medium-term circuits and direct traffic through them in fixed-size cells; circuits are establshed using public-key cryptography, while the transmission of cells requires simmetric-key encryption. Since there are various servers that relay cells along the circuit, each communicating only with its adjacent servers, none of them is able to determine whom the client application at one extreme of the circuit is communicating with. Tor builds up the circuit in stages, extending it one hop at a time, composing public-key encrypted messages in other to achieve perfect forward secrecy. To prevent attackers from running too many servers within the network, Tor relies on a set of <i>directory servers</i> that decide which nodes can join the network. Despite of this countermeasures, Tor has been shown ([1]) to be vulnerable to website fingerprinting attacks. Orbot is the official version of Tor for Android: an open-source free app that leverages Tor to anonymize the network traffic produced by other apps on Android (and Apple) devices. The only requirement for an app to be anonymized is that it includes the option of using a proxy to access the Internet: in fact Orbot sets a local server proxy to connect to the Tor network</p>

### Android traffic analysis

<p align="justify">Also mobile devices can be used as a weapon to violate the privacy of users. As pointed out by the authors in [2], in fact, software vulnerabities can be exploited to take over control of the device as well as monitoring the private data and the interactions of the users. But even fairly weak attackers, despite having no control on the device and only eavedropping its network traffic can threat the privacy of the users through <i>traffic analysis</i>. Many works indeed showed that even if the data are encrypted, the metadata of the packets carrying the data are sufficient, for example, to determine which apps are installed on the device or to detect if a user is inside a network at any moment. In [2], they claim they can push this even harder and find out the specific "actions" performed by a user while using some target applications. They manage to do it starting from the observation of the packets generated by the victim mobile device and applying some machine learning techniques. The authors also propose an ad-hoc framework for carrying on this specific attack; it is composed of two main components:</p>
<ol>
  <li>a <i>preprocessor</i>, which collects the raw network packets and extracts all the information available from their headers</li>
  <li>a <i>classifier</i>, in charge of classifying the traces coming from the preprocessor in order to determine the user action and the application they were originated from</li>
</ol>
<p align="justify">The preprocessor outputs the <i>network flow</i>, i.e. a sequence of TCP packets chronologically ordered, resulting from the application of some pre-processing steps to the network trace received in input:</p>
<ol>
  <li><i>domain filtering</i> excludes all the traffic generated by applications other than the analysed ones</li>
  <li><i>packets filtering</i> removes all the non-TCP packets, ACK packets, retransmissions packets and those packets related to the opening a TCP connection</li>
  <li><i>timeout and packets interval</i> limits the length of the network flow in output</li>
</ol>
<p align="justify">From the network flow, the preprocessor extracts three <i>time series</i></p>
<ol>
  <li>one is obtained considering the amount of bytes brought by the incoming packets</li>
  <li>another is obtained considering the amount of bytes brought by the outgoing packets</li>
  <li>the third one is obtained considering the amount of bytes brought by both incoming and outgoing packets</li>
</ol>
<p align="justify">Before using the classifier, it has to be trained with a label dataset. The first step consists in simulating the user actions and gathering the related network flows. The network flows are labeled with the name of the action by whom they have been produced and later they are grouped into clusters, in such a way that similar flows are assigned to the same cluster: similar flows are "close" to each other, while dissimilar flows are "far" from each other, where the distance is proportional to the cost of the <i>optimal warping path</i> between their respective time series. For each cluster is elected a leader, namely the flow with the minimum distance from all the other flows in the cluster. During the training phase, each labeled flow derived from a simulated user action is assigned to the cluster to which it is closer, that is the one whose leader is closer. In this way each user action is assigned a number of <i>features</i>, one for each cluster: the value of the k-th feature is equal to the number of labeled flows, produced by the action, that have been assigned to the k-th cluster. As a consequence, each user action will be characterised by a "signature", namely the set of values of the features, which will be unique and different from the one of the other actions. In this way, after the training phase, the classifier will be able to classify an unlabeled traffic trace by computing the values of its features and comparing them with the values of the labeled traces in the training set.
<br>
The above framework was tested on six popular Android applications (Gmail, Twitter, Tumblr, Dropbox, Google+ and Evernote) and it achieves very high level of accuracy in the classification of the user actions; in particular, the authors report that the values of the <i>F-measure</i> are above 90% with almost all the configurations, thus confirming that traffic analysis attacks can be very harmful.  
</p>

### Goal of the project

<p align="justify">All the traffic analysis attacks ultimately rely on the evaluation of some "features": as a matter of fact, the machine learning algorithms adopted manage to classify a network trace by comparing the values of its features with the values of the features of some previously seen training traces. As a consequence, the goal of this project consists in investigating whether an anonimity system can help preventing, or at least mitigating, traffic analysis attacks against Android devices modyfing the values of the features of the network traces produced by the applications in such way to fool the detection techniques applied by the attackers.      

## Implementation

### Architecture

<p align="justify">Drawing inspiration by [2], I implemented a framework to evaluate whether and how the features of the user actions analyzed in that paper assume different values when Orbot is activated compared to the case when no anonymization system is used. For each action, the framework essentially performs three tasks:</p>
<ol>
  <li><i>simulation of the action</i> (first with the default settings and then activating Orbot)</li>
  <li><i>collection of the derived network traces</i> (again, in both scenarios) </li>
  <li><i>plotting of the graphs related to the features</i></li>  
</ol>
<p align="justify">In order for the data to be more accurate, for each action the first two steps are iterated a number of times; as a consequence, the final plots show the average of the values collected during all the iterations.</p>

### Simulation of the user actions

<p align="justifY">The first step of each study is the generation, or the collection, of the data to be studied: in this case they are represented by the network traces produced by a user when he/she interacts with some mobile applications. In order to guarantee that the user actions are always performed in the same way, the framework simulates them in an automated way through the <i>ADB (Android Debug Bridge)</i>. This is a tool to interact with an Android device (emulated or a real one) by mean of a command-line interface. It can be used to install/unistall applications on the device, move files to/from it, control it using the embedded shell, manage the packets installed and many other things. The embedded sheel features <i>input</i>, a command to simulate the interaction of the user with the device, like a double tap on the screen: exploiting this command, the framework manages to trigger  the user actions on the Android devices.</p>


### Collection of the network traces

<p align="justify">In order to check how effective is the protection offered by Orbot against traffic analysis attacks, the network packets produced by the applications are captured, just like a passive attacker would do, first in the case where no defense is adopted and then in the case where the anonimity system is enabled on the device. In the proposed framework a dedicated bash script relies on the tool <i>tshark</i> to sniff the traffic generated by the Android device. Tshark is the command-line version of Wireshark, the well-known network protocol analyzer, so it allows to intercept the packets and then extract, for each protocol, the values of the related fields. Tshark comes with a set of <i>capture filters</i> and <i>display filters</i>: the former can be used to sniff a subset of all the packets travelling around the monitored subnetwork, while the latter can be used to show only a portion of the packets from the trace, after they have already been intercepted. Both the filters are used by the script to obtain the network traces necessary for the study:</p>
<ol>
  <li>a capture filter is applied to the source and the destination IP addresses of the packets in order to collect only the packets to and from the monitored device</li> 
  <li>some display filters are applied to mimic the work done by the preprocessor in [2] to clean the "noise" from the trace</li> 
</ol>

### Plotting of the graphs

<p align="justify">Once all the data have been gathered, a script draws some plots to represent the values of the features assigned to the network traces generated by the user actions: thanks to the graphs it gets easier to check whether some features change when the Android device is protected by an anonimity system.</p>

## Usage

<p align="justify">The main component of the framework is the script <i>bencharmker.sh</i>. It is meant to be run on the host that eavedrops the traffic generated by the Android device (they have to belong to the same subnetwork), after having set a few parameters:</p>
<ol>
  <li>the ID of the network card used to sniff the packets</li> 
  <li>the IP address assigned to the Android device to be monitored</li>
  <li>the path to the python script to be used: indeed, each action of each application is simulated by a dedicated script (in the folder <i>UserActions</i>)</li>
  <li>the number of times the user action has to be repeated before computing the average values of the features</li> 
</ol>
<p align="justify">During each iteration, the benchmarker collects two network traces induced by a user action, one in the default settings and the other after having set the Orbot proxy, and places them in the <i>Traces</i> folder. The traces are then processd, applying some filters, and the remaining packets lists are written to a .cvs file in the same folder. After all the iterations have been completed, the resulting graphs can be found in the <i>Plots</i> folder.</p>

## Results (TO BE CONTINUED)

<p align="justify">Results obtained so far have not been achieved using a real Android device, but using the <i>Genymotion Android Emulator</i> and setting its network to the <i>Bridge mode</i> so that it was possible to filter the traffic to/from the virtual device using its IP address.</p>

## References

<ul>
  <li><a href="https://www.usenix.org/node/184464">Effective Attacks and Provable Defenses for Website Fingerprinting</a> [Tao Wang, University of Waterloo; Xiang Cai, Rishab Nithyanand, and Rob Johnson, Stony Brook University; Ian Goldberg, University of Waterloo]</li>
  <li><a href="https://svn.torproject.org/svn/projects/design-paper/tor-design.pdf">Tor: The Second-Generation Onion Router</a> [Roger Dingledine and Nick Mathewson, The Free Haven Project; Paul Syverson, Naval Research Lab]</li>
  <li><a href="ieeexplore.ieee.org/document/7265055">Analyzing Android Encrypted Network
Traffic to Identify User Actions</a> [Mauro Conti and Riccardo Spolaor, Dipartimento di Matematica, Università di Padova; Luigi Vincenzo Mancini, Dipartimento di Informatica, Sapienza Università di Roma]</li>
  <li><a href="https://guardianproject.info/apps/orbot/">Orbot: Tor for Android</a></li>
  <li><a href="https://developer.android.com/studio/command-line/adb.html">Android Debug Bridge (adb)</a></li>
  <li><a href="https://www.wireshark.org/docs/man-pages/tshark.html">Tshark</a></li>
  <li><a href="https://www.genymotion.com/">Genymotion Android Emulator</a></li>
</ul>
